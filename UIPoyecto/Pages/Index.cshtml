@page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

<section class="colum5050">
    <div class="box container">
        <h2>Peso Promedio de Especies</h2>
        <canvas class="max-H-300" id="pastelPesoEspecie"></canvas>
    </div>
    <div class="box container">

        <canvas class="max-H-300" id="yearsChart1"></canvas>
    </div>
</section>
<section class="colum2 margin-top">
    <div class="box container">
        <h2>
            Comparativa de características:
            <select class="input" id="idGaleras" style="width: 25%; height: 1.8rem; cursor: pointer; margin-left: .8rem">
                <option value="0">Galera 1</option>
                <option value="1">Galera 2</option>
                <option value="2">Galera 3</option>
            </select>
        </h2>
        <canvas class="max-H-300" id="decesosDiariosId"></canvas>
    </div>
    <div class="box container">
        <h2>
            Comparativa de características:
            <select class="input" id="idEspecies" style="width: 25%; height: 1.8rem; cursor: pointer; margin-left: .8rem">
                <option value="0">Danès</option>
                <option value="1">NewCoaster</option>
                <option value="2">Amarillos Pequeños</option>
            </select>
        </h2>
        <canvas class="max-H-300" id="radarEspecie"></canvas>
    </div>
</section>

<script type="module">
    Chart.defaults.color = '#9fa3a9'
    Chart.defaults.borderColor = '#9fa3a9'

    const decesosByGalera = [];
    const pesoPromedioByEspecie = [];
    const especieDetalle = [
        {
            valor: 20,
            propiedad: 'Costo'
        },
        {
            valor: 6,
            propiedad: 'SemanasProduccion'
        }, {
            valor: 2,
            propiedad: 'ConsumoDiario'
        }, {
            valor: 5,
            propiedad: 'PesoFinal'
        },

    ]


    window.onload = () => {
        document.querySelector("#idGaleras").addEventListener("change", function () {
            //renderYearsChart(decesosByGalera[this.value]);
            const chart = Chart.getChart(decesosDiariosId);
            chart.data.datasets[0].data = decesosByGalera[this.value].map(x => x.decesos);
            chart.update();
        });
    }

    pesoPromedioByEspecie.push(
        [
            {
                Peso: 10,
                Especie: 'Danés'
            }, {
                Peso: 35,
                Especie: 'NewCoaster'
            }, {
                Peso: 10,
                Especie: 'AmarillosPequeños'
            }, {
                Peso: 12,
                Especie: 'Gran Cabestia'
            }, {
                Peso: 40,
                Especie: 'Hondureños'
            }, {
                Peso: 20,
                Especie: 'CR'
            },

        ]

    );

    decesosByGalera.push(
        [
            {
                decesos: 3,
                dia: 'Lunes'
            },
            {
                decesos: 1,
                dia: 'Martes'
            }, {
                decesos: 2,
                dia: 'Miercoes'
            }, {
                decesos: 0,
                dia: 'Jueves'
            }, {
                decesos: 4,
                dia: 'Viernes'
            }, {
                decesos: 1,
                dia: 'Sabado'
            }, {
                decesos: 0,
                dia: 'Domingo'
            },

        ]

    );
    decesosByGalera.push(
        [
            {
                decesos: 1,
                dia: 'Lunes'
            },
            {
                decesos: 2,
                dia: 'Martes'
            }, {
                decesos: 2,
                dia: 'Miercoes'
            }, {
                decesos: 0,
                dia: 'Jueves'
            }, {
                decesos: 0,
                dia: 'Viernes'
            }, {
                decesos: 0,
                dia: 'Sabado'
            }, {
                decesos: 0,
                dia: 'Domingo'
            },
        ]
    );
    decesosByGalera.push(
        [
            {
                decesos: 3,
                dia: 'Lunes'
            },
            {
                decesos: 1,
                dia: 'Martes'
            }, {
                decesos: 0,
                dia: 'Miercoes'
            }, {
                decesos: 0,
                dia: 'Jueves'
            }, {
                decesos: 1,
                dia: 'Viernes'
            }, {
                decesos: 10,
                dia: 'Sabado'
            }, {
                decesos: 1,
                dia: 'Domingo'
            },

        ]

    );

    const printCharts = () => {

        fetchCoastersData('https://localhost:5001/api/EspeciePollo/GetEspeciesNombreCompuesto')
            .then(([allCoasters]) => {

                renderGraficoPastel(pesoPromedioByEspecie[0])
                renderFeaturesChart(especieDetalle)
                lineaDecesosdiarios(decesosByGalera[0])
                enableEventHandlers(allCoasters)
            })

    }



    const renderGraficoPastel = x => {

        const data = {
            labels: x.map(x => x.Especie),
            datasets: [{
                data: x.map(x => x.Peso),
                borderColor: getDataColors(),
                backgroundColor: getDataColors(90)
            }]
        }

        const options = {
            plugins: {
                legend: { position: 'top' }
            }
        }

        new Chart('pastelPesoEspecie', { type: 'doughnut', data, options })
    }


    const renderFeaturesChart = x => {

        const data = {
            labels: x.map(x => x.propiedad),
            datasets: [{
                label: 'Danes',
                data: x.map(x => x.valor),
                borderColor: getDataColors()[0],
                backgroundColor: getDataColors(20)[0]
            }]
        }

        new Chart('radarEspecie', { type: 'radar', data })
    }



    //funmcionando
    const lineaDecesosdiarios = x => {


        const data = {
            labels: x.map(x => x.dia),
            datasets: [{
                data: x.map(x => x.decesos),
                label: 'Decesos Diarios Por Galera',
                tension: .5,
                borderColor: getDataColors()[1],
                backgroundColor: getDataColors(20)[1],
                fill: true,
                pointBorderWidth: 5
            }]
        }

        const options = {
            plugins: {
                legend: { display: false }
            }
        }

        new Chart('decesosDiariosId', { type: 'line', data })
    }



    const enableEventHandlers = coasters => {

        document.querySelector('#idGaleras').onchange = e => {

            const { value: property, text: label } = e.target.selectedOptions[0]

            const newData = decesosByGalera[this.value];

            updateChartData('yearsChart', newData, label)
        }
    }

    const fetchCoastersData = (...urls) => {
        const promises = urls.map(url => fetch(url).then(response => response.json()))
        return Promise.all(promises)
    }

    const getDataColors = opacity => {
        const colors = ['#7448c2', '#21c0d7', '#d99e2b', '#cd3a81', '#9c99cc', '#e14eca', '#ffffff', '#ff0000', '#d6ff00', '#0038ff', '#a40b54', '#5e9fa3', '#660860', '#9380b7']
        return colors.map(color => opacity ? `${color + opacity}` : color)
    }

    const getCoastersByYear = (coasters, years) => {
        const coastersByYear = years.map(yearsRange => {
            const [from, to] = yearsRange.split('-')
            return coasters.filter(eachCoaster => eachCoaster.year >= from && eachCoaster.year <= to).length
        })
        return coastersByYear
    }

    const updateChartData = (chartId, data, label) => {
        const chart = Chart.getChart(chartId)
        chart.data.datasets[0].data = data
        chart.data.datasets[0].label = label
        chart.update()
    }



    printCharts();






</script>
